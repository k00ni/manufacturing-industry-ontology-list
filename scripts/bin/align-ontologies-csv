#!/usr/bin/env php
<?php

/**
 * This file alignes content of ontologies.csv.
 */

declare(strict_types=1);

$alignedData = [];

foreach (array_map('str_getcsv', file(__DIR__.'/../../ontologies.csv')) as $rawEntry) {
    $alignedEntry = [];
    foreach ($rawEntry as $key => $value) {
        // replace multiple whitespaces with 1 whitespace
        $value = preg_replace('/\s+/', ' ', $value);

        $value = str_replace([', ', ' ,'], ',', $value);

        // remove trailing whitespaces
        $alignedEntry[$key] = trim($value);
    }

    // short description must end with a dot
    if ('.' != mb_substr($rawEntry[3], -1)) {
        $rawEntry[3] .= '.';
    }

    $alignedData[] = $alignedEntry;
}

// check for doublings in abbreviation column
$abbreviations = [];
foreach ($alignedData as $entry) {
    if (
        in_array($entry[2], $abbreviations, true)
        && 'Information not available' !== $entry[2]
    ) {
        echo PHP_EOL;
        echo 'Abbreviation doubling found: '.$entry[2].' (used again in '. $entry[0].')';
        echo PHP_EOL;
        return;
    } else {
        $abbreviations[] = $entry[2];
    }
}

// self check to avoid false positive
if (0 == count($abbreviations)) {
    throw new Exception('$abbreviations is empty');
}

// write aligned data back to ontologies.csv
$path = __DIR__.'/../../ontologies.csv';
$fp = fopen($path, 'w'); // open in write only mode (write at the start of the file)
foreach ($alignedData as $row) {
    fputcsv($fp, $row);
}
fclose($fp);

echo PHP_EOL;