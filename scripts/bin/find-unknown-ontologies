#!/usr/bin/env php
<?php

/**
 * This file generates config code for graph visualization on yuml.me.
 */

declare(strict_types=1);

use quickRdf\DataFactory;
use quickRdfIo\RdfIoException;
use quickRdfIo\Util;
use sweetrdf\InMemoryStoreSqlite\Store\InMemoryStoreSqlite;

require __DIR__.'/../src/bootstrap.php';

$dataFactory = new DataFactory();
$unknownOntologies = [];

echo PHP_EOL;

foreach ($simplifiedOntologyList as $iri => $entry) {
    echo PHP_EOL.'.';

    if (0 == strlen($entry['rdfxml_file']) && 0 == strlen($entry['turtle_file'])) {
        continue;
    }

    // download file and read content
    if (0 < strlen($entry['rdfxml_file'])) {
        $format = 'rdf';
        $rdfFileContent = getContentOfRdfFile($entry['rdfxml_file']);
    } else {
        $format = 'turtle';
        $rdfFileContent = getContentOfRdfFile($entry['turtle_file']);
    }

    if (
        0 === strlen($rdfFileContent)
        || '404: Not Found' == $rdfFileContent
        || str_contains($rdfFileContent, '<html ')
    ) {
        echo PHP_EOL.$iri.' > no data or 404 > IGNORED';
        continue;
    } elseif (null === guessFormat($rdfFileContent)) {
        echo PHP_EOL.$iri.' > it neither RDF/XML nor Turtle data > IGNORED'.PHP_EOL;
        continue;
    }

    $relevantQuads = [];
    try {
        // parse a file
        $iterator = Util::parse($rdfFileContent, $dataFactory, $format);
        $i = 0;
        foreach ($iterator as $item) {
            $relevantQuads[] = $item;
            if ($i++ > 500) {
                // only take a limit amount to avoid the script run too long
                break;
            }
        }
    } catch (RdfIoException $e) {
        echo PHP_EOL.' > Exception while parsing content for IRI ('.$iri.'): '.$e->getMessage();
        continue;
    }

    $store = InMemoryStoreSqlite::createInstance();
    $store->addQuads($relevantQuads);

    // go through the list of namespace IRIs and owl:imports
    $iris = array_merge(
        getNamespaceUriListUsedInRdfFile($rdfFileContent, $format),
        getOwlImportIris($store)
    );

    foreach ($iris as $referencedOntologyFileUrl) {
        echo ',';

        $data = getContentOfRdfFile($referencedOntologyFileUrl);
        $format = guessFormat($data);
        if (null == $format) {
            // echo PHP_EOL.$ontologyIri.' its neither RDF/XML nor Turtle > IGNORE'.PHP_EOL;
            continue;
        }

        // parse RDF data to get ontology IRI
        try {
            $iterator = Util::parse($data, $dataFactory, $format);
            $i = 0;
            $relevantQuads = [];
            foreach ($iterator as $item) {
                $relevantQuads[] = $item;
                if ($i++ > 300) {
                    // only take a limit amount to avoid the script run for too long
                    break;
                }
            }
        } catch (RdfIoException $e) {
            echo PHP_EOL.' > Exception while parsing content for IRI ('.$referencedOntologyFileUrl.'): '.$e->getMessage();
            continue;
        }

        // read file content into in-memory SPARQL store
        $store = InMemoryStoreSqlite::createInstance();
        $store->addQuads($relevantQuads);

        $result = $store->query('SELECT ?iri WHERE {?iri a owl:Ontology.}');

        if (1 == count($result['result']['rows'])) {
            $ontologyIRI = $result['result']['rows'][0]['iri'];

            // get related ontology title
            if (isOntologyIriAlreadyKnown($ontologyIRI) || isset($unknownOntologies[$ontologyIRI])) {
                // is known
                continue;
            } else {
                $unknownOntologies[$ontologyIRI] = $ontologyIRI;

                echo PHP_EOL;
                echo '#############################################################################################';
                echo PHP_EOL.'UNKNOWN: '.$ontologyIRI.PHP_EOL;
                echo 'used in: '.$iri.PHP_EOL;
                echo '#############################################################################################';
                echo PHP_EOL;

                echo PHP_EOL;
                echo getCSVLineForOntology($referencedOntologyFileUrl, $store, $format);
                echo PHP_EOL;
                echo PHP_EOL;

                return 1;
            }
        } else {
            continue;
        }
    }

    if (0 == count($iris)) {
        throw new Exception($entry['ontology_iri'].': No related namespaces and owl:imports found!');
    }
}

echo PHP_EOL;

if (0 < count($unknownOntologies)) {
    return 1;
} else {
    return 0;
}