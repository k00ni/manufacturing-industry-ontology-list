#!/usr/bin/env php
<?php

/**
 * This file generates config code for graph visualization on yuml.me.
 */

declare(strict_types=1);

/**
 * Saves information about ontologies and their interrelations.
 *
 * There are some predefined entries which do point to either no valid ontologies or redirect to correct URLs.
 *
 * @var array<string,array<mixed>>
 */
$simplifiedOntologyList = [
    // could not found related ontology for this ontology IRI
    // BioPortal support contacted about the URL
    'http://data.bioontology.org/metadata/' => [
        'abbreviation' => 'obo',
        'key' => 'open_biological_and_biomedical_ontology_foundry',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://purl.obolibrary.org/obo/',
    ],
    // not a real ontology
    'http://dbpedia.org/resource/' => [
        'abbreviation' => 'dbpedia_org_resource',
        'key' => 'dbpedia_org_resource',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://dbpedia.org/resource/',
    ],
    // not a real ontology
    'http://en.wikipedia.org/wiki/' => [
        'abbreviation' => 'obo',
        'key' => 'en_wikipedia_org_wiki',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://en.wikipedia.org/wiki/',
    ],
    // not a real ontology
    'http://jena.hpl.hp.com/ARQ/function#' => [
        'abbreviation' => '?',
        'key' => 'jena_hpl_hp_com_arq_function',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://jena.hpl.hp.com/ARQ/function#',
    ],
    // could not found related ontology for this ontology IRI
    'http://www.ontologyrepository.com/CommonCoreOntologies/' => [
        'abbreviation' => '?',
        'key' => 'ontology_repository_common_core_ontologies',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://www.ontologyrepository.com/CommonCoreOntologies/',
    ],
    // could not found related ontology for this ontology IRI
    // http://vocab.org does not have an appropriate entry
    'http://open.vocab.org/terms/' => [
        'abbreviation' => '?',
        'key' => 'open_vocab_org_terms',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://open.vocab.org/terms/',
    ],
    // could not found related ontology for this ontology IRI
    // redirects to:
    // https://www1.owl-ontologies.com/?tm=1&subid4=170990725http://www.owl-ontologies.com/2005/08/07/xsp.owl#5.0125660000&KW1=Semantic%20Data%20Model%20Ontology&KW2=Data%20Analytics%20Database&KW3=Human%20Disease%20Document%20Management%20Software&searchbox=0&domainname=0&backfill=0
    'http://www.owl-ontologies.com/2005/08/07/xsp.owl#' => [
        'abbreviation' => '?',
        'key' => 'owl_ontologies_com_xsp_owl',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://www.owl-ontologies.com/2005/08/07/xsp.owl#',
    ],
    // added because it doesn't reference a certain ontology, but seems to be a placeholder
    // which points to a list of ontologies (https://obofoundry.org/).
    // in RDF data you might see entries like "obo:RO_0001900" which point to an entry in
    // https://obofoundry.org/ontology/ro.html, which has http://purl.obolibrary.org/obo/ro.owl#
    // as ontology IRI.
    'http://purl.obolibrary.org/obo/' => [
        'abbreviation' => 'obo',
        'key' => 'open_biological_and_biomedical_ontology_foundry',
        'rdf_file' => null,
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
        'ontology_iri' => 'http://purl.obolibrary.org/obo/',
    ],
    // all Dublin Core IRIs (e.g. http://purl.org/dc/terms/, http://purl.org/dc/dcam/) point/redirect to
    // https://www.dublincore.org/specifications/dublin-core/dcmi-terms/
    // both DCTerms and DCElements also reference the same terms/elements
    'http://purl.org/dc/dcmitype/' => [
        'abbreviation' => 'dcmitype',
        'key' => 'dcmi_type',
        'rdf_file' => null,
        'ontology_iri' => 'http://purl.org/dc/dcmitype/',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    'http://purl.org/dc/dcam/' => [
        'abbreviation' => 'dcam',
        'key' => 'dcam',
        'rdf_file' => null,
        'ontology_iri' => 'http://purl.org/dc/dcam/',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // GoodRelations vocabulary was merged into schema.org in 2012 and no longer has a RDF file of its own
    'http://purl.org/goodrelations/v1#' => [
        'abbreviation' => 'GR',
        'key' => 'good_relations_ontology',
        'rdf_file' => null,
        'ontology_iri' => 'http://purl.org/goodrelations/v1#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    'http://purl.org/net/vocab/2004/03/label#' => [
        'abbreviation' => '?',
        'key' => 'purl_net_vocab_2004_03_label',
        'rdf_file' => null,
        'ontology_iri' => 'http://purl.org/net/vocab/2004/03/label#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    'http://purl.org/obo/owl/' => [
        'abbreviation' => '?',
        'key' => 'obo_owl',
        'rdf_file' => null,
        'ontology_iri' => 'http://purl.org/obo/owl/',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    'http://purl.org/obo/oban/' => [
        'abbreviation' => '?',
        'key' => 'obo_oban',
        'rdf_file' => null,
        'ontology_iri' => 'http://purl.org/obo/oban/',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // Sometimes authors use https://schema.org/ instead of the original URL http://schema.org/
    // this entry is only for easing data management
    'https://schema.org/' => [
        'abbreviation' => 'sdo',
        'key' => 'schema_org',
        'rdf_file' => null,
        'ontology_iri' => 'https://schema.org/',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    'http://spinrdf.org/arg#' => [
        'abbreviation' => '?',
        'key' => 'spinrdf_org_arg',
        'rdf_file' => null,
        'ontology_iri' => 'http://spinrdf.org/arg#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // just a redirect
    'https://www.w3.org/2002/07/owl#' => [
        'abbreviation' => 'owl',
        'key' => 'web_ontology_language',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/2002/07/owl#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // just a redirect
    'https://www.w3.org/1999/02/22-rdf-syntax-ns#' => [
        'abbreviation' => 'rdf',
        'key' => 'resource_description_framework',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // just a redirect
    'https://www.w3.org/2000/01/rdf-schema#' => [
        'abbreviation' => 'rdfs',
        'key' => 'resource_description_framework_schema_vocabulary',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/2000/01/rdf-schema#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // just a redirect
    'https://www.w3.org/2001/XMLSchema#' => [
        'abbreviation' => 'xsd',
        'key' => 'extensible_markup_language_schema',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/2001/XMLSchema#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    'http://www.w3.org/2003/11/swrl#' => [
        'abbreviation' => 'owl',
        'key' => 'semantic_Web_rule_language',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/2003/11/swrl#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    'http://www.w3.org/2003/11/swrlb#' => [
        'abbreviation' => '?',
        'key' => 'swrl_b',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/2003/11/swrlb#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    // https://www.w3.org/2003/g/data-view#
    'http://www.w3.org/2003/g/data-view#' => [
        'abbreviation' => '?',
        'key' => 'grddl_data_views',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/2003/g/data-view#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
    // could not found related ontology for this ontology IRI
    // http://www.w3.org/2005/xpath-functions#
    'http://www.w3.org/2005/xpath-functions#' => [
        'abbreviation' => 'fn',
        'key' => 'xpath_functions',
        'rdf_file' => null,
        'ontology_iri' => 'http://www.w3.org/2005/xpath-functions#',
        'ignore_it' => true, // if true, it will be ignored when loading RDF file later on
    ],
];

// load CSV file and build simplified ontology list
foreach (array_map('str_getcsv', file(__DIR__.'/../ontologies.csv')) as $line => $entry) {
    if (0 == $line) {
        continue;
    }

    // build line with entry ID and label
    $key = strtolower($entry[0]);
    $key = str_replace([' ', '.', ':'], '_', $key);
    $key = str_replace(',', '', $key);
    $key = str_replace('-', '_', $key);

    // abbreviation
    $abbreviation = strtolower($entry[2]);
    $abbreviation = str_replace('-', '', $abbreviation);

    // related RDF file
    $ontologyIRI = $entry[7];
    if (false === str_starts_with($entry[7], 'http')) {
        // if ontology IRI isn't starting with http, therefore its not an URI
        // in this case use RDF file instead
        $ontologyIRI = $entry[6];
    }

    // related RDF file
    $rdfFile = (string) $entry[8];

    if (0 == strlen($rdfFile)) {
        // throw new Exception($title.' has no RDF file URL');
        continue;
    }

    $simplifiedOntologyList[$ontologyIRI] = [
        'abbreviation' => $abbreviation,
        'key' => $key,
        'rdf_file' => $rdfFile,
        'ontology_iri' => $ontologyIRI,
        'ignore_it' => false,
    ];
}

// ignore SSL problems in https-based connections
$context = stream_context_create([
    'ssl' => [
      'verify_peer' => false,
      'verify_peer_name' => false,
    ]
]);

$fileContent = '';

foreach ($simplifiedOntologyList as $iri => $entry) {
    if (true === $entry['ignore_it']) {
        // ignore this entry (for reasons look above)
        continue;
    } elseif (str_contains($entry['rdf_file'], 'Information not available')) {
        continue;
    } else {
        // download file and read content
        $rdfFileContent = file_get_contents($entry['rdf_file'], false, $context);
    }

    // assume its RDF/Turtle
    if (
        str_contains($entry['rdf_file'], '.n3')
        || str_contains($entry['rdf_file'], '.ttl')
    ) {
        $regex = '/[@prefix]+\s+[a-z]+:\s*<(.*?)>/msi';
    } else {
        // XML file
        $regex = '/xmlns:[a-z]+="(.*?)"/smi';
    }

    if (0 < preg_match_all($regex, $rdfFileContent, $namespaceIRIs)) {
        $list = [];

        // go through the list of namespace IRIs
        foreach ($namespaceIRIs[1] as $iri) {
            // get related ontology title
            if (isset($simplifiedOntologyList[$iri])) {
                // current ontology
                $from = strtolower($entry['key']);
                // referenced ontology
                $to = strtolower($simplifiedOntologyList[$iri]['key']);

                // add line to file content
                $fileContent .= '['.$from.']->['.$to.']'.PHP_EOL;
            } else {
                echo PHP_EOL.'In '. $entry['key'].' found unknown namespace IRI: '.$iri;
            }
        }
    } else {
        throw new Exception($entry['key'].': No related namespaces found!');
    }
}

file_put_contents(__DIR__.'/../yuml-diagram-config.txt', $fileContent);

echo PHP_EOL;